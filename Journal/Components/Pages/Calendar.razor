@page "/calendar"
@using Journal.Models
@using Journal.Services
@inject JournalService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-outline-secondary" @onclick="PrevMonth">&lt; Previous</button>
        <h3>@CurrentMonth.ToString("MMMM yyyy")</h3>
        <button class="btn btn-outline-secondary" @onclick="NextMonth">Next &gt;</button>
    </div>
   <div class="mb-2">
    <span class="badge-pill" style="background:#16a34a; color:white;">
        Longest Streak: @MonthLongestStreak
    </span>

    <span class="badge-pill" style="background:#dc2626; color:white;">
        Missed Days: @MonthMissedDays
    </span>
</div>

    <div class="card-ui p-3 mb-3">
        <div class="d-flex flex-wrap align-items-center gap-2">
            <strong>Export Journals</strong>
            <input type="date" class="input-ui" style="max-width:200px" @bind="ExportFrom" />
            <input type="date" class="input-ui" style="max-width:200px" @bind="ExportTo" />
            <button class="btn-ui btn-ui-primary" type="button" @onclick="ExportPdf">Export as PDF</button>
        </div>
        @if (!string.IsNullOrEmpty(ExportStatus))
        {
            <div class="mt-2 p-muted">@ExportStatus</div>
        }
    </div>

    @if (IsLoading)
    {
        <div class="text-center py-4">
            <p class="lead">Loading calendar...</p>
        </div>
    }
    else
    {
        <div class="calendar-grid">
            <div class="row text-center fw-bold mb-2">
                <div class="col">Sun</div>
                <div class="col">Mon</div>
                <div class="col">Tue</div>
                <div class="col">Wed</div>
                <div class="col">Thu</div>
                <div class="col">Fri</div>
                <div class="col">Sat</div>
            </div>

            @for (int week = 0; week < Weeks.Count; week++)
            {
                <div class="row mb-2">
                    @foreach (var day in Weeks[week])
                    {
                        <div class="col border p-2 text-center position-relative"
                             style="height: 100px; cursor: pointer; background-color: @(day.Date.Date == DateTime.Today ? "#e8f4fd" : (day.IsCurrentMonth ? "white" : "#f8f9fa")); opacity: @(day.IsCurrentMonth ? "1" : "0.6")"
                             @onclick="() => SelectDate(day.Date)">

                            <div class="d-flex justify-content-between">
                                <span class="fw-bold small">@day.Date.Day</span>
                                @if (day.HasEntry)
                                {
                                    <span class="badge bg-success rounded-circle p-1" style="width: 8px; height: 8px;"> </span>
                                }
                            </div>

                            @if (day.HasEntry)
                            {
                                <div class="mt-2">
                                    <div style="font-size: 1.5rem;">@day.MoodEmoji</div>
                                    <div class="small text-truncate text-muted" style="font-size: 0.7rem;">
                                        @day.EntryTitle
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    private DateTime CurrentMonth = DateTime.Today;
    private List<List<CalendarDay>> Weeks = new();
    private bool IsLoading = true;
    private int MonthLongestStreak = 0;
    private int MonthMissedDays = 0;
    private DateTime? ExportFrom = null;
    private DateTime? ExportTo = null;
    private string ExportStatus = "";

    // Cache entries by date for quick lookup
    private Dictionary<DateTime, JournalEntry> EntriesByDate = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthAsync();
    }

    private async Task PrevMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        await LoadMonthAsync();
    }

    private async Task NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        await LoadMonthAsync();
    }

    private async Task LoadMonthAsync()
    {
        IsLoading = true;

        try
        {
            // Load all entries once, then filter in memory (simple + stable)
            var all = await JournalService.GetAllEntriesAsync();

            EntriesByDate = all
                .GroupBy(e => e.Date.Date)
                .ToDictionary(g => g.Key, g => g.First());

            GenerateCalendar();
            ComputeMonthStats();
        }
        catch (Exception ex)
        {
            await Application.Current?.MainPage?.DisplayAlert("Error", ex.Message, "OK");
            Weeks = new();
            EntriesByDate = new();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void GenerateCalendar()
    {
        Weeks = new List<List<CalendarDay>>();

        var firstDayOfMonth = new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1);
        var startDayOfWeek = (int)firstDayOfMonth.DayOfWeek;

        var currentDay = firstDayOfMonth.AddDays(-startDayOfWeek);

        bool done = false;
        while (!done)
        {
            var week = new List<CalendarDay>();

            for (int j = 0; j < 7; j++)
            {
                EntriesByDate.TryGetValue(currentDay.Date, out var entry);

                week.Add(new CalendarDay
                {
                    Date = currentDay,
                    IsCurrentMonth = currentDay.Month == CurrentMonth.Month,
                    HasEntry = entry != null,
                    EntryTitle = entry?.Title ?? "",
                    MoodEmoji = entry?.PrimaryMood?.Emoji ?? ""
                });

                if (j == 6 && currentDay.Month != CurrentMonth.Month && currentDay > firstDayOfMonth)
                    done = true;

                currentDay = currentDay.AddDays(1);
            }

            Weeks.Add(week);
            if (Weeks.Count >= 6) done = true;
        }
    }

    private void SelectDate(DateTime date)
    {
        Navigation.NavigateTo($"/?date={date:yyyy-MM-dd}");
    }

    private void ComputeMonthStats()
    {
        var first = new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1);
        var days = DateTime.DaysInMonth(CurrentMonth.Year, CurrentMonth.Month);
        var longest = 0;
        var current = 0;
        var missed = 0;
        for (int i = 0; i < days; i++)
        {
            var d = first.AddDays(i).Date;
            var has = EntriesByDate.ContainsKey(d);
            if (has)
            {
                current++;
                if (current > longest) longest = current;
            }
            else
            {
                current = 0;
                missed++;
            }
        }
        MonthLongestStreak = longest;
        MonthMissedDays = missed;
    }
    private async Task ExportPdf()
    {
        try
        {
            ExportStatus = "";
            var entries = await JournalService.SearchEntriesAsync(null, ExportFrom, ExportTo, new List<string>(), new List<string>());

            if (entries.Count == 0)
            {
                ExportStatus = "No entries found for the selected date range.";
                return;
            }

            var html = BuildExportHtml(entries);
            await JS.InvokeVoidAsync("printHtml", "Journal Export", html);
            ExportStatus = $"Prepared {entries.Count} entries. Printing...";
        }
        catch (Exception ex)
        {
            ExportStatus = $"Export failed: {ex.Message}";
        }
    }

    private string BuildExportHtml(List<JournalEntry> entries)
    {
        var sb = new System.Text.StringBuilder();
        sb.Append("<!DOCTYPE html><html><head><meta charset='utf-8'/>");
        sb.Append("<title>Journal Export</title>");
        sb.Append("<style>");
        sb.Append("body{font-family:Arial, sans-serif; color:#111827; margin:24px;}");
        sb.Append(".entry{margin:16px 0; padding:12px; border:1px solid #e5e7eb; border-radius:8px;}");
        sb.Append(".title{font-weight:700; font-size:16px; margin:0 0 6px 0;}");
        sb.Append(".meta{font-size:12px; color:#6b7280; margin-bottom:8px;}");
        sb.Append(".content{font-size:14px; line-height:1.5;}");
        sb.Append("</style></head><body>");
        sb.Append("<h2>Journal Export</h2>");
        foreach (var e in entries.OrderBy(x => x.Date))
        {
            var tagsList = e.Tags ?? new List<string>();
            var tagsJoined = tagsList.Count > 0 ? string.Join(", ", tagsList) : "";
            var secList = e.SecondaryMoods ?? new List<Mood>();
            var secJoined = secList.Count > 0 ? string.Join(", ", secList.Select(m => (m.Emoji ?? "") + " " + (m.Name ?? "")).Select(s => s.Trim())) : "";
            var primaryEmoji = e.PrimaryMood?.Emoji ?? "";
            var primaryName = e.PrimaryMood?.Name ?? "";
            var primaryDisplay = (primaryEmoji + " " + primaryName).Trim();
            var metaParts = new List<string>();
            if (!string.IsNullOrWhiteSpace(primaryDisplay)) metaParts.Add("Primary: " + System.Net.WebUtility.HtmlEncode(primaryDisplay));
            if (!string.IsNullOrWhiteSpace(secJoined)) metaParts.Add("Secondary: " + System.Net.WebUtility.HtmlEncode(secJoined));
            if (!string.IsNullOrWhiteSpace(tagsJoined)) metaParts.Add("Tags: " + System.Net.WebUtility.HtmlEncode(tagsJoined));
            sb.Append("<div class='entry'>");
            sb.Append("<div class='meta'>" + e.Date.ToString("dddd, MMMM dd, yyyy") + "</div>");
            sb.Append("<div class='title'>" + System.Net.WebUtility.HtmlEncode(e.Title ?? "") + "</div>");
            if (metaParts.Count > 0)
            {
                sb.Append("<div class='meta'>" + string.Join(" | ", metaParts) + "</div>");
            }
            sb.Append("<div class='content'>" + (e.Content ?? "") + "</div>");
            sb.Append("</div>");
        }
        sb.Append("</body></html>");
        return sb.ToString();
    }

    private class CalendarDay
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
        public bool HasEntry { get; set; }
        public string EntryTitle { get; set; } = "";
        public string MoodEmoji { get; set; } = "";
    }
}
