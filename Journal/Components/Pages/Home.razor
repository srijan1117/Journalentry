@page "/"
@using Journal.Models
@using Journal.Services
@inject JournalService JournalService
@inject NavigationManager Navigation

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-outline-secondary" @onclick="PreviousDay">&lt; Previous</button>
        <h3>@CurrentDate.ToString("D")</h3>
        <button class="btn btn-outline-secondary" @onclick="NextDay" disabled="@IsFutureDate">Next &gt;</button>
    </div>

    @if (IsLoading)
    {
        <div class="text-center py-5">
            <p class="lead">Loading...</p>
        </div>
    }
    else if (CurrentEntry == null)
    {
        <div class="text-center py-5">
            <p class="lead">No entry for this day.</p>
            <button class="btn btn-primary btn-lg" @onclick="CreateEntry">Start Journaling</button>
        </div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Title</label>
                    <input type="text" class="form-control" @bind="CurrentEntry.Title" placeholder="Give your day a title..." />
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Primary Mood</label>
                        <select class="form-select" @bind="SelectedPrimaryMoodName">
                            <option value="">Select Mood...</option>
                            @foreach (var mood in AvailableMoods)
                            {
                                <option value="@mood.Name">@mood.Emoji @mood.Name</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">Secondary Moods (Max 2)</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var mood in AvailableMoods)
                            {
                                var isSelected = IsSecondaryMoodSelected(mood);
                                <button type="button"
                                        class="btn btn-sm @(isSelected ? "btn-info" : "btn-outline-secondary")"
                                        @onclick="() => ToggleSecondaryMood(mood)">
                                    @mood.Emoji
                                </button>
                            }
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Content</label>
                    <textarea class="form-control" rows="12" @bind="CurrentEntry.Content" placeholder="Write about your day..."></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Tags</label>
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var tag in AvailableTags)
                        {
                            var isSelected = CurrentEntry.Tags.Contains(tag);
                            <span class="badge rounded-pill @(isSelected ? "bg-primary" : "bg-light text-dark border")"
                                  style="cursor: pointer; user-select: none;"
                                  @onclick="() => ToggleTag(tag)">
                                @tag
                            </span>
                        }
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-4">
                    <button class="btn btn-danger" @onclick="DeleteEntry">Delete</button>
                    <div>
                        <span class="text-muted small me-2">@SaveStatus</span>
                        <button class="btn btn-success px-4" @onclick="SaveEntry">Save Entry</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private DateTime CurrentDate = DateTime.Today;
    private JournalEntry? CurrentEntry;

    private List<Mood> AvailableMoods = new();
    private List<string> AvailableTags = new();

    private bool IsLoading = true;
    private string SaveStatus = "";

    private bool IsFutureDate => CurrentDate.Date >= DateTime.Today;

    private string SelectedPrimaryMoodName
    {
        get => CurrentEntry?.PrimaryMood?.Name ?? "";
        set
        {
            if (CurrentEntry != null)
            {
                var selected = AvailableMoods.FirstOrDefault(m => m.Name == value);
                if (selected != null)
                    CurrentEntry.PrimaryMood = selected;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        ParseDateFromQuery();

        AvailableMoods = JournalService.GetAvailableMoods();
        AvailableTags = JournalService.GetAvailableTags();

        await LoadEntryAsync();
    }

    private void ParseDateFromQuery()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = uri.Query;

        if (string.IsNullOrWhiteSpace(query) || !query.Contains("date="))
            return;

        try
        {
            var parts = query.Split(new[] { "date=" }, StringSplitOptions.None);
            if (parts.Length <= 1) return;

            var dateVal = parts[1].Split('&')[0];
            if (DateTime.TryParse(dateVal, out var parsedDate))
                CurrentDate = parsedDate.Date;
        }
        catch
        {
        }
    }

    private async Task LoadEntryAsync()
    {
        IsLoading = true;
        SaveStatus = "";

        try
        {
            CurrentEntry = await JournalService.GetEntryByDateAsync(CurrentDate);
        }
        catch (Exception ex)
        {
            CurrentEntry = null;
            await Application.Current?.MainPage?.DisplayAlert("Error", ex.Message, "OK");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task PreviousDay()
    {
        CurrentDate = CurrentDate.AddDays(-1);
        await LoadEntryAsync();
    }

    private async Task NextDay()
    {
        if (!IsFutureDate)
        {
            CurrentDate = CurrentDate.AddDays(1);
            await LoadEntryAsync();
        }
    }

    private void CreateEntry()
    {
        CurrentEntry = new JournalEntry { Date = CurrentDate };
        SaveStatus = "";
    }

    private async Task SaveEntry()
    {
        if (CurrentEntry == null) return;

        try
        {
            if (string.IsNullOrWhiteSpace(CurrentEntry.Title))
                CurrentEntry.Title = "Untitled";

            await JournalService.SaveEntryAsync(CurrentEntry);
            SaveStatus = "Saved at " + DateTime.Now.ToShortTimeString();
        }
        catch (Exception ex)
        {
            await Application.Current?.MainPage?.DisplayAlert("Save Failed", ex.Message, "OK");
        }
    }

    private async Task DeleteEntry()
    {
        if (CurrentEntry == null) return;

        try
        {
            await JournalService.DeleteEntryByDateAsync(CurrentEntry.Date);
            CurrentEntry = null;
            SaveStatus = "";
        }
        catch (Exception ex)
        {
            await Application.Current?.MainPage?.DisplayAlert("Delete Failed", ex.Message, "OK");
        }
    }

    private bool IsSecondaryMoodSelected(Mood mood)
    {
        return CurrentEntry?.SecondaryMoods.Any(m => m.Name == mood.Name) ?? false;
    }

    private void ToggleSecondaryMood(Mood mood)
    {
        if (CurrentEntry == null) return;

        var existing = CurrentEntry.SecondaryMoods.FirstOrDefault(m => m.Name == mood.Name);
        if (existing != null)
        {
            CurrentEntry.SecondaryMoods.Remove(existing);
        }
        else
        {
            if (CurrentEntry.SecondaryMoods.Count < 2)
                CurrentEntry.SecondaryMoods.Add(mood);
        }
    }

    private void ToggleTag(string tag)
    {
        if (CurrentEntry == null) return;

        if (CurrentEntry.Tags.Contains(tag))
            CurrentEntry.Tags.Remove(tag);
        else
            CurrentEntry.Tags.Add(tag);
    }
}
