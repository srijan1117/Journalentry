@page "/editor"
@using Journal.Models
@using Journal.Services
@inject JournalService JournalService

<h2>Today's Journal Entry</h2>

@if (IsLoading)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="Entry" OnValidSubmit="SaveAsync">
        <DataAnnotationsValidator />

        <div class="card p-3">
            <div class="mb-3">
                <label class="form-label">Title</label>
                <InputText class="form-control" @bind-Value="Entry.Title" />
            </div>

            <div class="mb-3">
                <label class="form-label">Content</label>
                <InputTextArea class="form-control" rows="8" @bind-Value="Entry.Content" />
            </div>

            <div class="mb-3">
                <label class="form-label">Primary Mood *</label>
                <select class="form-select" @bind="SelectedMoodName">
                    <option value="">-- Select Mood --</option>
                    @foreach (var mood in AvailableMoods)
                    {
                        <option value="@mood.Name">@mood.Emoji @mood.Name</option>
                    }
                </select>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save / Update</button>
                <button type="button" class="btn btn-danger" @onclick="DeleteAsync">Delete</button>
            </div>

            @if (Entry.CreatedAt != default)
            {
                <p class="text-muted small mt-3 mb-0">
                    Created: @Entry.CreatedAt <br />
                    Updated: @Entry.UpdatedAt
                </p>
            }
        </div>
    </EditForm>
}

@code {
    private JournalEntry Entry = new() { Date = DateTime.Today };
    private List<Mood> AvailableMoods = new();
    private bool IsLoading = true;

    private string SelectedMoodName
    {
        get => Entry.PrimaryMood?.Name ?? "";
        set
        {
            var selected = AvailableMoods.FirstOrDefault(m => m.Name == value);
            if (selected != null)
                Entry.PrimaryMood = selected;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        AvailableMoods = JournalService.GetAvailableMoods();

        try
        {
            var existing = await JournalService.GetEntryByDateAsync(DateTime.Today);
            if (existing != null)
                Entry = existing;
        }
        catch (Exception ex)
        {
            await Application.Current?.MainPage?.DisplayAlert("Error", ex.Message, "OK");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task SaveAsync()
    {
        try
        {
            if (Entry.PrimaryMood == null || string.IsNullOrWhiteSpace(Entry.PrimaryMood.Name))
            {
                await Application.Current?.MainPage?.DisplayAlert("Missing Mood", "Please select a primary mood.", "OK");
                return;
            }

            if (string.IsNullOrWhiteSpace(Entry.Title))
                Entry.Title = "Untitled";

            await JournalService.SaveEntryAsync(Entry);

            await Application.Current?.MainPage?.DisplayAlert("Saved", "Entry saved successfully.", "OK");
        }
        catch (Exception ex)
        {
            await Application.Current?.MainPage?.DisplayAlert("Save Failed", ex.Message, "OK");
        }
    }

    private async Task DeleteAsync()
    {
        try
        {
            await JournalService.DeleteEntryByDateAsync(DateTime.Today);
            Entry = new JournalEntry { Date = DateTime.Today };

            await Application.Current?.MainPage?.DisplayAlert("Deleted", "Today's entry deleted.", "OK");
        }
        catch (Exception ex)
        {
            await Application.Current?.MainPage?.DisplayAlert("Delete Failed", ex.Message, "OK");
        }
    }
}
