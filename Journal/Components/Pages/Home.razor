@page "/"
@using Journal.Models
@using Journal.Services
@inject JournalService JournalService
@inject NavigationManager Navigation

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-outline-secondary" @onclick="PreviousDay">&lt; Previous</button>
        <h3>@CurrentDate.ToString("D")</h3>
        <button class="btn btn-outline-secondary" @onclick="NextDay" disabled="@IsFutureDate">Next &gt;</button>
    </div>

    @if (CurrentEntry == null)
    {
        <div class="text-center py-5">
            <p class="lead">No entry for this day.</p>
            <button class="btn btn-primary btn-lg" @onclick="CreateEntry">Start Journaling</button>
        </div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Title</label>
                    <input type="text" class="form-control" @bind="CurrentEntry.Title" placeholder="Give your day a title..." />
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Primary Mood</label>
                        <select class="form-select" @bind="SelectedPrimaryMoodName">
                            <option value="">Select Mood...</option>
                            @foreach (var mood in AvailableMoods)
                            {
                                <option value="@mood.Name">@mood.Emoji @mood.Name</option>
                            }
                        </select>
                    </div>
                     <div class="col-md-6">
                        <label class="form-label fw-bold">Secondary Moods (Max 2)</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var mood in AvailableMoods)
                            {
                                var isSelected = IsSecondaryMoodSelected(mood);
                                <button class="btn btn-sm @(isSelected ? "btn-info" : "btn-outline-secondary")" 
                                        @onclick="() => ToggleSecondaryMood(mood)">
                                    @mood.Emoji
                                </button>
                            }
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Content</label>
                    <textarea class="form-control" rows="12" @bind="CurrentEntry.Content" placeholder="Write about your day... (Markdown supported)"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Tags</label>
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var tag in AvailableTags)
                        {
                            var isSelected = CurrentEntry.Tags.Contains(tag);
                            <span class="badge rounded-pill @(isSelected ? "bg-primary" : "bg-light text-dark border")" 
                                  style="cursor: pointer; user-select: none;"
                                  @onclick="() => ToggleTag(tag)">
                                @tag
                            </span>
                        }
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-4">
                    <button class="btn btn-danger" @onclick="DeleteEntry">Delete</button>
                    <div>
                         <span class="text-muted small me-2">@SaveStatus</span>
                        <button class="btn btn-success px-4" @onclick="SaveEntry">Save Entry</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private DateTime CurrentDate = DateTime.Today;
    private JournalEntry? CurrentEntry;
    private List<Mood> AvailableMoods = new();
    private List<string> AvailableTags = new();
    
    private string SelectedPrimaryMoodName 
    {
        get => CurrentEntry?.PrimaryMood?.Name ?? "";
        set 
        {
            if (CurrentEntry != null)
            {
                CurrentEntry.PrimaryMood = AvailableMoods.FirstOrDefault(m => m.Name == value);
            }
        }
    }

    private string SaveStatus = "";
    private bool IsFutureDate => CurrentDate.Date >= DateTime.Today;

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = uri.Query;
        if (!string.IsNullOrEmpty(query) && query.Contains("date="))
        {
            try
            {
                var parts = query.Split(new[] { "date=" }, StringSplitOptions.None);
                if (parts.Length > 1)
                {
                     var dateVal = parts[1].Split('&')[0];
                     if (DateTime.TryParse(dateVal, out var parsedDate))
                     {
                         CurrentDate = parsedDate;
                     }
                }
            }
            catch { /* Ignore parsing errors */ }
        }

        AvailableMoods = JournalService.GetAvailableMoods();
        AvailableTags = JournalService.GetAvailableTags();
        LoadEntry();
    }

    private void LoadEntry()
    {
        CurrentEntry = JournalService.GetEntryByDate(CurrentDate);
        SaveStatus = "";
    }

    private void PreviousDay()
    {
        CurrentDate = CurrentDate.AddDays(-1);
        LoadEntry();
    }

    private void NextDay()
    {
        if (!IsFutureDate)
        {
            CurrentDate = CurrentDate.AddDays(1);
            LoadEntry();
        }
    }

    private void CreateEntry()
    {
        CurrentEntry = new JournalEntry { Date = CurrentDate };
    }

    private void SaveEntry()
    {
        if (CurrentEntry != null)
        {
            if (string.IsNullOrWhiteSpace(CurrentEntry.Title)) CurrentEntry.Title = "Untitled";
            JournalService.SaveEntry(CurrentEntry);
            SaveStatus = "Saved at " + DateTime.Now.ToShortTimeString();
        }
    }

    private void DeleteEntry()
    {
        if (CurrentEntry != null)
        {
            JournalService.DeleteEntry(CurrentEntry.Id);
            CurrentEntry = null;
        }
    }

    private bool IsSecondaryMoodSelected(Mood mood)
    {
        return CurrentEntry?.SecondaryMoods.Any(m => m.Name == mood.Name) ?? false;
    }

    private void ToggleSecondaryMood(Mood mood)
    {
        if (CurrentEntry == null) return;
        
        var existing = CurrentEntry.SecondaryMoods.FirstOrDefault(m => m.Name == mood.Name);
        if (existing != null)
        {
            CurrentEntry.SecondaryMoods.Remove(existing);
        }
        else
        {
            if (CurrentEntry.SecondaryMoods.Count < 2)
            {
                CurrentEntry.SecondaryMoods.Add(mood);
            }
        }
    }

    private void ToggleTag(string tag)
    {
        if (CurrentEntry == null) return;

        if (CurrentEntry.Tags.Contains(tag))
        {
            CurrentEntry.Tags.Remove(tag);
        }
        else
        {
            CurrentEntry.Tags.Add(tag);
        }
    }
}
